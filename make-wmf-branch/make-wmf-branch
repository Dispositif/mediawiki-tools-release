#!/usr/bin/env php
<?php
require __DIR__ . '/cli.php';

if ( count( $argv ) < 3 ) {
	echo "Usage: make-wmf-branch <new-version> <old-version> <path to clone>\n";
	echo "Example: make-wmf-branch 1.20wmf2 1.20wmf1\n";
	echo " <path to clone>, if given, is a local clone on disk to use\n";
	exit( 1 );
}

$current_branch = trim(`git symbolic-ref HEAD`);
$abort = false;
if ($current_branch == 'refs/heads/master') {
    echo "Verifying that make-wmf-branch is up to date with origin/master...";
    shell_exec('git fetch');
    $log = `git log HEAD..origin/master --pretty=oneline`;
    $logsize = strlen($log);
    if ($logsize > 0) {
        $abort=true;
        $reason = "Out of date, you need to integrate these commits from origin/master:\n";
        $reason .= $log;
        echo "\n";
    } else {
        echo "ok\n";
    }
} else {
    $abort=true;
    $reason = "Wrong branch: $current_branch. Please run make-wmf-branch from the latest master revision.";
}

if ($abort) {
    echo "Aborting make-wmf-branch:\n";
    echo "Reason: $reason\n";
    exit(1);
}

$changes = trim('git status --porcelain');
if (!empty($changes)) {
    echo "Warning: You have local changes in your tools/release checkout:\n";
    echo $changes."\n\n";
}

$newVersion = $argv[1];
$oldVersion = $argv[2];
$clonePath = isset( $argv[3] ) ? $argv[3] : null;

require_once( __DIR__ . '/MakeWmfBranch.php' );

$obj = new MakeWmfBranch( $newVersion, $oldVersion );
$obj->execute( $clonePath );
